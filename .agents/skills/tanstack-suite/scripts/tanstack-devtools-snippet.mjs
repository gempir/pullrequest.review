#!/usr/bin/env node
/**
 * TanStack devtools snippet generator (read-only)
 *
 * Reads package.json and prints a TSX snippet that matches the installed
 * devtools host/plugins and (optionally) Query/Router dedicated devtools.
 */

import fs from 'fs'
import path from 'path'

function parseArgs(argv) {
  const args = { cwd: null, json: false, help: false }
  for (let i = 2; i < argv.length; i++) {
    const a = argv[i]
    if (a === '--help' || a === '-h') args.help = true
    else if (a === '--json') args.json = true
    else if (a === '--cwd') {
      const v = argv[i + 1]
      if (!v) throw new Error('Missing value for --cwd')
      args.cwd = v
      i++
    } else {
      throw new Error(`Unknown arg: ${a}`)
    }
  }
  return args
}

function findUpPackageJson(startDir) {
  let dir = startDir
  for (let i = 0; i < 50; i++) {
    const candidate = path.join(dir, 'package.json')
    if (fs.existsSync(candidate)) return candidate
    const parent = path.dirname(dir)
    if (parent === dir) break
    dir = parent
  }
  return null
}

function readJson(filePath) {
  return JSON.parse(fs.readFileSync(filePath, 'utf8'))
}

function pickDeps(pkgJson) {
  const out = {}
  for (const field of ['dependencies', 'devDependencies', 'optionalDependencies', 'peerDependencies']) {
    if (pkgJson && typeof pkgJson[field] === 'object') Object.assign(out, pkgJson[field])
  }
  return out
}

function main() {
  const args = parseArgs(process.argv)

  if (args.help) {
    process.stdout.write(
      [
        'TanStack devtools snippet generator (read-only)',
        '',
        'Usage:',
        '  node tanstack-devtools-snippet.mjs',
        '  node tanstack-devtools-snippet.mjs --cwd path/to/project',
        '  node tanstack-devtools-snippet.mjs --json',
        '',
      ].join('\n'),
    )
    return
  }

  const startDir = args.cwd ? path.resolve(process.cwd(), args.cwd) : process.cwd()
  const pkgPath = findUpPackageJson(startDir)
  if (!pkgPath) {
    console.error('❌ Could not find package.json. Use --cwd to point at a project directory.')
    process.exit(1)
  }

  const root = path.dirname(pkgPath)
  const pkgJson = readJson(pkgPath)
  const deps = pickDeps(pkgJson)

  const hasHost = Boolean(deps['@tanstack/react-devtools'])
  const plugins = {
    form: Boolean(deps['@tanstack/react-form-devtools']),
    pacer: Boolean(deps['@tanstack/react-pacer-devtools']),
    ai: Boolean(deps['@tanstack/react-ai-devtools']),
  }
  const hasAnyPlugin = Object.values(plugins).some(Boolean)

  const dedicated = {
    query: Boolean(deps['@tanstack/react-query-devtools']),
    router: Boolean(deps['@tanstack/react-router-devtools']),
  }

  const installs = []
  if (!hasHost && hasAnyPlugin) installs.push('@tanstack/react-devtools')
  if (plugins.form && !hasHost) installs.push('@tanstack/react-devtools')

  const report = {
    projectRoot: root,
    hasHost,
    plugins,
    dedicated,
    suggestedInstall: installs.length ? `npm i -D ${[...new Set(installs)].join(' ')}` : null,
    snippet: null,
  }

  // Build snippet
  const lines = []
  lines.push('/**')
  lines.push(' * Devtools snippet generated by tanstack-devtools-snippet.mjs')
  lines.push(' *')
  lines.push(' * NOTE: import.meta.env.PROD is Vite-style; adjust for your bundler.')
  lines.push(' */')
  lines.push('')

  const imports = []
  if (hasHost && hasAnyPlugin) {
    imports.push("import { TanStackDevtools } from '@tanstack/react-devtools'")
    if (plugins.form) imports.push("import { formDevtoolsPlugin } from '@tanstack/react-form-devtools'")
    if (plugins.pacer) imports.push("import { pacerDevtoolsPlugin } from '@tanstack/react-pacer-devtools'")
    if (plugins.ai) imports.push("import { aiDevtoolsPlugin } from '@tanstack/react-ai-devtools'")
  } else if (hasHost) {
    // Host but no plugins: still useful to render an empty panel if desired.
    imports.push("import { TanStackDevtools } from '@tanstack/react-devtools'")
  }

  if (dedicated.query) imports.push("import { ReactQueryDevtools } from '@tanstack/react-query-devtools'")
  if (dedicated.router) imports.push("import { TanStackRouterDevtools } from '@tanstack/react-router-devtools'")

  if (imports.length) {
    lines.push(...imports)
    lines.push('')
  }

  lines.push('export function Devtools() {')
  lines.push('  if (import.meta.env.PROD) return null')
  lines.push('')
  lines.push('  return (')
  lines.push('    <>')

  if (hasHost) {
    if (hasAnyPlugin) {
      const pluginCalls = []
      if (plugins.form) pluginCalls.push('formDevtoolsPlugin()')
      if (plugins.pacer) pluginCalls.push('pacerDevtoolsPlugin()')
      if (plugins.ai) pluginCalls.push('aiDevtoolsPlugin()')

      if (plugins.ai) {
        lines.push('      <TanStackDevtools')
        lines.push(`        plugins={[${pluginCalls.join(', ')}]}`)
        lines.push('        eventBusConfig={{ connectToServerBus: true }}')
        lines.push('      />')
      } else {
        lines.push(`      <TanStackDevtools plugins={[${pluginCalls.join(', ')}]} />`)
      }
    } else {
      lines.push('      {/* TanStack Devtools host installed, but no plugins detected */}')
      lines.push('      <TanStackDevtools />')
    }
  } else if (hasAnyPlugin) {
    lines.push(
      '      {/* Devtools plugins detected but @tanstack/react-devtools is missing. Install it to use the unified panel. */}',
    )
  } else {
    lines.push('      {/* No TanStack Devtools host/plugins detected */}')
  }

  if (dedicated.query) lines.push('      <ReactQueryDevtools initialIsOpen={false} />')
  if (dedicated.router) lines.push('      <TanStackRouterDevtools />')

  lines.push('    </>')
  lines.push('  )')
  lines.push('}')

  report.snippet = lines.join('\n')

  if (args.json) {
    process.stdout.write(JSON.stringify(report, null, 2) + '\n')
    return
  }

  console.log('TanStack devtools snippet generator')
  console.log('Project:', root)
  console.log('')

  if (!hasHost && hasAnyPlugin) {
    console.log('⚠️  Plugins detected but host panel missing.')
    console.log('Suggested install:')
    console.log(`  npm i -D @tanstack/react-devtools`)
    console.log('')
  }

  console.log('Paste this into a dev-only component (or your app root):')
  console.log('')
  console.log(report.snippet)
}

try {
  main()
} catch (err) {
  console.error('❌', err?.message ?? err)
  process.exit(1)
}
